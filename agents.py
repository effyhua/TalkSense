"""
å¤šæ™ºèƒ½ä½“ç³»ç»Ÿï¼šåŒ…å«4ä¸ªä¸åŒé£æ ¼çš„AIæ™ºèƒ½ä½“
æ¯ä¸ªé—®é¢˜éƒ½ä¼šè®©4ä¸ªæ™ºèƒ½ä½“éƒ½å›ç­”ï¼Œæä¾›ä¸åŒè§†è§’çš„å»ºè®®
"""
import os
import time
from typing import Dict, List, Any
from prompts import AGENT_PROMPTS

# å°è¯•åŠ è½½ dotenv
try:
    from dotenv import load_dotenv
    load_dotenv()
except ImportError:
    pass

class AgentSystem:
    """å¤šæ™ºèƒ½ä½“ç³»ç»Ÿ"""
    
    def __init__(self):
        self.api_key = os.getenv("GEMINI_API_KEY", "")
        # æ™ºèƒ½ä½“åç§°åˆ—è¡¨ï¼Œæ‰€æœ‰promptéƒ½åœ¨prompts.pyä¸­å®šä¹‰
        self.agent_names = list(AGENT_PROMPTS.keys())
    
    def get_responses(self, user_input: str) -> Dict[str, str]:
        """
        è·å–æ‰€æœ‰æ™ºèƒ½ä½“çš„å›å¤
        æ¯ä¸ªé—®é¢˜éƒ½ä¼šè®©4ä¸ªæ™ºèƒ½ä½“éƒ½å›ç­”ï¼Œæä¾›ä¸åŒè§†è§’çš„å»ºè®®
        æ¯ä¸ªæ™ºèƒ½ä½“ä¼šè‡ªå·±åˆ†ææ„å›¾å¹¶ç»™å‡ºå›å¤
        
        Args:
            user_input: ç”¨æˆ·è¾“å…¥çš„åŸå§‹æ–‡æœ¬
            
        Returns:
            åŒ…å«å„æ™ºèƒ½ä½“å›å¤çš„å­—å…¸ï¼Œé”®ä¸ºæ™ºèƒ½ä½“åç§°ï¼Œå€¼ä¸ºå›å¤å†…å®¹
        """
        responses = {}
        
        # éå†æ‰€æœ‰æ™ºèƒ½ä½“ï¼Œæ¯ä¸ªéƒ½å›ç­”åŒä¸€ä¸ªé—®é¢˜
        for i, agent_name in enumerate(self.agent_names):
            if self.api_key:
                # åœ¨è¯·æ±‚ä¹‹é—´æ·»åŠ å»¶è¿Ÿï¼Œé¿å…APIè¿‡è½½
                if i > 0:
                    time.sleep(0.5)  # æ¯ä¸ªè¯·æ±‚é—´éš”0.5ç§’
                response = self._get_gemini_response(agent_name, user_input)
            else:
                response = self._get_demo_response(agent_name, user_input)
            
            responses[agent_name] = response
        
        return responses
    
    def _get_gemini_response(self, agent_name: str, user_input: str, max_retries: int = 3) -> str:
        """ä½¿ç”¨Gemini APIç”Ÿæˆæ™ºèƒ½ä½“å›å¤ï¼Œæ¯ä¸ªè§’è‰²ä½¿ç”¨å¯¹åº”çš„promptï¼Œè‡ªå·±åˆ†ææ„å›¾
        
        Args:
            agent_name: æ™ºèƒ½ä½“åç§°
            user_input: ç”¨æˆ·è¾“å…¥
            max_retries: æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤3æ¬¡ï¼‰
        """
        from google import genai
        
        # åˆ›å»ºGeminiå®¢æˆ·ç«¯
        client = genai.Client(api_key=self.api_key)
        
        # ä»prompts.pyè·å–å¯¹åº”è§’è‰²çš„promptæ¨¡æ¿
        prompt_template = AGENT_PROMPTS.get(agent_name, "")
        if not prompt_template:
            raise ValueError(f"æœªæ‰¾åˆ°æ™ºèƒ½ä½“ {agent_name} çš„promptæ¨¡æ¿")
        
        # å¡«å……promptæ¨¡æ¿ï¼ˆåªä¼ å…¥ç”¨æˆ·è¾“å…¥ï¼Œè®©LLMè‡ªå·±åˆ†ææ„å›¾ï¼‰
        prompt = prompt_template.format(user_input=user_input)
        
        # é‡è¯•æœºåˆ¶ï¼šå¯¹äº503ç­‰ä¸´æ—¶é”™è¯¯è¿›è¡Œé‡è¯•
        for attempt in range(max_retries):
            try:
                # è°ƒç”¨Gemini APIç”Ÿæˆå›å¤
                response = client.models.generate_content(
                    model="gemini-3-flash-preview",
                    contents=prompt,
                )
                
                # å¤„ç†å“åº”ï¼Œåªæå–æ–‡æœ¬éƒ¨åˆ†ï¼Œå¿½ç•¥thought_signatureç­‰éæ–‡æœ¬éƒ¨åˆ†
                if hasattr(response, 'candidates') and response.candidates:
                    # ä»candidatesä¸­æå–æ–‡æœ¬éƒ¨åˆ†
                    text_parts = []
                    for candidate in response.candidates:
                        if hasattr(candidate, 'content') and hasattr(candidate.content, 'parts'):
                            for part in candidate.content.parts:
                                if hasattr(part, 'text') and part.text:
                                    text_parts.append(part.text)
                    if text_parts:
                        return ''.join(text_parts).strip()
                
                # å¦‚æœä¸Šè¿°æ–¹æ³•å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨textå±æ€§
                if hasattr(response, 'text'):
                    return response.text.strip()
                
                # å¦‚æœéƒ½å¤±è´¥ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯
                return "æŠ±æ­‰ï¼Œæ— æ³•è·å–å›å¤å†…å®¹ã€‚"
                
            except Exception as e:
                error_str = str(e)
                
                # æ£€æŸ¥æ˜¯å¦æ˜¯é…é¢é™åˆ¶é”™è¯¯
                is_quota_error = (
                    'quota' in error_str.lower() or
                    'QuotaFailure' in error_str or
                    '429' in error_str or
                    'RESOURCE_EXHAUSTED' in error_str
                )
                
                # æ£€æŸ¥æ˜¯å¦æ˜¯503é”™è¯¯ï¼ˆæ¨¡å‹è¿‡è½½ï¼‰æˆ–å…¶ä»–å¯é‡è¯•çš„é”™è¯¯
                is_retryable = (
                    '503' in error_str or 
                    'UNAVAILABLE' in error_str or
                    'overloaded' in error_str.lower() or
                    'rate limit' in error_str.lower()
                )
                
                if is_quota_error:
                    # é…é¢é™åˆ¶é”™è¯¯ï¼Œä¸é‡è¯•ï¼Œç›´æ¥è¿”å›å‹å¥½æç¤º
                    return f"âš ï¸ APIé…é¢å·²ç”¨å®Œï¼ˆæ¯æ—¥å…è´¹é¢åº¦20æ¬¡ï¼‰ã€‚è¯·æ˜å¤©å†è¯•ï¼Œæˆ–å‡çº§åˆ°ä»˜è´¹è®¡åˆ’ã€‚\n\nğŸ’¡ æç¤ºï¼šä½ å¯ä»¥æš‚æ—¶ä½¿ç”¨æ¼”ç¤ºæ¨¡å¼ï¼Œè™½ç„¶å›å¤æ˜¯é¢„è®¾çš„ï¼Œä½†ä¹Ÿèƒ½æä¾›å‚è€ƒã€‚"
                
                if is_retryable and attempt < max_retries - 1:
                    # æŒ‡æ•°é€€é¿ï¼šç­‰å¾…æ—¶é—´é€æ¸å¢åŠ 
                    wait_time = (2 ** attempt) * 0.5  # 0.5ç§’, 1ç§’, 2ç§’
                    print(f"Gemini APIè°ƒç”¨å¤±è´¥ ({agent_name})ï¼Œ{wait_time}ç§’åé‡è¯• (å°è¯• {attempt + 1}/{max_retries})...")
                    time.sleep(wait_time)
                    continue
                else:
                    # æœ€åä¸€æ¬¡å°è¯•å¤±è´¥ï¼Œæˆ–è€…ä¸æ˜¯å¯é‡è¯•çš„é”™è¯¯
                    print(f"Gemini APIè°ƒç”¨å¤±è´¥ ({agent_name}): {e}")
                    # å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œå›é€€åˆ°æ¼”ç¤ºæ¨¡å¼
                    return self._get_demo_response(agent_name, user_input)
        
        # æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥äº†
        print(f"Gemini APIè°ƒç”¨å¤±è´¥ ({agent_name})ï¼Œå·²é‡è¯•{max_retries}æ¬¡ï¼Œä½¿ç”¨æ¼”ç¤ºæ¨¡å¼")
        return self._get_demo_response(agent_name, user_input)
    
    def _get_demo_response(self, agent_name: str, user_input: str) -> str:
        """ç”Ÿæˆæ¼”ç¤ºå›å¤ï¼ˆå½“æ²¡æœ‰APIæ—¶ä½¿ç”¨ï¼‰"""
        
        # æ ¹æ®æ™ºèƒ½ä½“å’Œåœºæ™¯ç”Ÿæˆä¸åŒçš„å›å¤
        if agent_name == "æ½®æµè¾¾äºº":
            if "é’ˆå¯¹" in user_input or "å·¥ä½œ" in user_input:
                return "ç¬‘æ­»ï¼Œè¿™æ³¢æ“ä½œå±å®æœ‰ç‚¹ä¸‹å¤´ğŸ˜… å»ºè®®ä½ ç›´æ¥å›ï¼š'æ”¶åˆ°ï¼Œæˆ‘å¤ç›˜ä¸€ä¸‹ï¼Œæœ‰å…·ä½“é—®é¢˜æˆ‘ä»¬å†å¯¹ä¸€ä¸‹å“ˆï½' æ—¢ä¸å¤±ç¤¼è²Œåˆæ˜¾å¾—ä½ å¾ˆä¸“ä¸šï¼Œè¿˜ä¸ä¼šè¢«ä»–å¸¦èŠ‚å¥ã€‚å¦‚æœä»–è¿˜ç»§ç»­æäº‹ï¼Œç›´æ¥ç”©ä¸ªè¡¨æƒ…åŒ…ï¼š'ğŸ¤”' è®©ä»–è‡ªå·±å“ã€‚"
            elif "æš§æ˜§" in user_input or "å–œæ¬¢" in user_input:
                return "è¿™é¢˜æˆ‘ä¼šï¼ç›´æ¥å›ï¼š'ä½ çŒœï¼ŸğŸ˜' æˆ–è€… 'ä½ å¸Œæœ›æ˜¯å“ªä¸ªç­”æ¡ˆå‘¢ï½' ä¿æŒç¥ç§˜æ„Ÿï¼Œè®©ä»–ä¸»åŠ¨ã€‚è®°ä½ï¼Œæš§æ˜§çš„ç²¾é«“å°±æ˜¯ï¼šä¸ä¸»åŠ¨ã€ä¸æ‹’ç»ã€ä¸è´Ÿè´£ï¼ˆå¼€ç©ç¬‘çš„å“ˆå“ˆï¼‰ã€‚"
            else:
                return "è¿™æ³¢å±å®æœ‰ç‚¹éš¾é¡¶ï¼Œä½†é—®é¢˜ä¸å¤§ï¼å»ºè®®ä½ ï¼š1. å…ˆç¨³ä½å¿ƒæ€ï¼Œåˆ«è¢«å¸¦èŠ‚å¥ 2. ç”¨è½»æ¾çš„è¯­æ°”åŒ–è§£å°´å°¬ 3. å¦‚æœå¯¹æ–¹å¤ªè¿‡åˆ†ï¼Œç›´æ¥å¼€æ€¼ä½†ä¿æŒå¹½é»˜ã€‚è®°ä½ï¼Œä½ çš„æ€åº¦å†³å®šåˆ«äººæ€ä¹ˆå¯¹ä½ ï½"
        
        elif agent_name == "ç¤¾äº¤å¤–äº¤å®˜":
            if "é’ˆå¯¹" in user_input or "å·¥ä½œ" in user_input:
                return "å»ºè®®é‡‡ç”¨'å…ˆè®¤å¯åæ¾„æ¸…'çš„ç­–ç•¥ï¼š'æ„Ÿè°¢ä½ çš„åé¦ˆï¼Œæˆ‘ä¼šè®¤çœŸå¤ç›˜ã€‚ä¸ºäº†æ›´å¥½åœ°æ”¹è¿›ï¼Œèƒ½å¦å…·ä½“æŒ‡å‡ºå“ªäº›æ–¹é¢éœ€è¦è°ƒæ•´ï¼Ÿè¿™æ ·æˆ‘å¯ä»¥æ›´æœ‰é’ˆå¯¹æ€§åœ°ä¼˜åŒ–ã€‚' æ—¢å±•ç°äº†ä¸“ä¸šæ€åº¦ï¼Œåˆé¿å…äº†ç›´æ¥å†²çªï¼ŒåŒæ—¶è®©å¯¹æ–¹æä¾›å…·ä½“ä¿¡æ¯ã€‚"
            elif "æš§æ˜§" in user_input or "å–œæ¬¢" in user_input:
                return "å¯ä»¥è¿™æ ·å›å¤ï¼š'å’Œä½ èŠå¤©æ€»æ˜¯å¾ˆæ„‰å¿«ï¼Œæˆ‘ä¹Ÿå¾ˆçæƒœæˆ‘ä»¬ä¹‹é—´çš„äº’åŠ¨ã€‚' æ—¢è¡¨è¾¾äº†ç§¯ææ€åº¦ï¼Œåˆä¿æŒäº†é€‚å½“çš„è·ç¦»æ„Ÿï¼Œè®©å¯¹æ–¹æ„Ÿå—åˆ°ä½ çš„é‡è§†ï¼ŒåŒæ—¶ä¸ä¼šæ˜¾å¾—è¿‡äºä¸»åŠ¨ã€‚"
            else:
                return "å»ºè®®é‡‡ç”¨'å…±æƒ…+è§£å†³æ–¹æ¡ˆ'çš„æ–¹å¼ï¼šå…ˆç†è§£å¯¹æ–¹çš„æƒ…ç»ªå’Œéœ€æ±‚ï¼Œç„¶åæä¾›å»ºè®¾æ€§çš„å»ºè®®ã€‚ä¿æŒä¸“ä¸šã€æ¸©å’Œä½†åšå®šçš„æ€åº¦ï¼Œç»´æŠ¤å¥½è‡ªå·±çš„è¾¹ç•ŒåŒæ—¶ç»´æŠ¤å…³ç³»ã€‚"
        
        elif agent_name == "çŠ€åˆ©ç›´çƒæ‰‹":
            if "é’ˆå¯¹" in user_input or "å·¥ä½œ" in user_input:
                return "ç›´æ¥å›ï¼š'å…·ä½“å“ªé‡Œæœ‰é—®é¢˜ï¼ŸæŒ‡å‡ºæ¥ï¼Œæˆ‘æ”¹ã€‚å¦‚æœæ˜¯è¯¯ä¼šï¼Œæˆ‘ä»¬å½“é¢è¯´æ¸…æ¥šã€‚' ä¸ç»•å¼¯å­ï¼Œä¸èƒŒé”…ï¼Œä¹Ÿä¸ä¸»åŠ¨æŒ‘èµ·å†²çªã€‚å¦‚æœä»–ç»™ä¸å‡ºå…·ä½“é—®é¢˜ï¼Œé‚£å°±æ˜¯ä»–åœ¨æäº‹ï¼Œç›´æ¥æ— è§†æˆ–è€…å›ï¼š'æ²¡æœ‰å…·ä½“é—®é¢˜çš„è¯ï¼Œè¿™ä¸ªè¯é¢˜å°±åˆ°æ­¤ä¸ºæ­¢å§ã€‚'"
            elif "æš§æ˜§" in user_input or "å–œæ¬¢" in user_input:
                return "ç›´æ¥é—®ï¼š'ä½ æ˜¯æƒ³ç¡®è®¤ä»€ä¹ˆï¼Ÿ' æˆ–è€… 'ä½ è§‰å¾—å‘¢ï¼Ÿ' æŠŠçƒè¸¢å›å»ï¼Œè®©ä»–å…ˆè¡¨æ€ã€‚å¦‚æœä»–å«ç³Šå…¶è¾ï¼Œç›´æ¥è¯´ï¼š'æˆ‘è§‰å¾—æˆ‘ä»¬ä¹‹é—´éœ€è¦æ›´æ˜ç¡®çš„æ²Ÿé€šã€‚' ä¸ç©çŒœå¿ƒæ¸¸æˆï¼Œè¦å°±ç›´è¯´ï¼Œä¸è¦å°±åˆ«æµªè´¹å½¼æ­¤æ—¶é—´ã€‚"
            else:
                return "ç›´æ¥ç‚¹ï¼Œåˆ«ç»•å¼¯å­ã€‚æ˜ç¡®è¡¨è¾¾ä½ çš„ç«‹åœºå’Œåº•çº¿ï¼Œå¦‚æœå¯¹æ–¹è¶Šç•Œï¼Œç›´æ¥æŒ‡å‡ºã€‚ç”¨äº‹å®è¯´è¯ï¼Œä¸æƒ…ç»ªåŒ–ï¼Œä½†ä¹Ÿä¸é€€è®©ã€‚è®°ä½ï¼šä½ çš„è¾¹ç•Œæ˜¯ä½ è‡ªå·±å®šä¹‰çš„ï¼Œä¸éœ€è¦åˆ«äººåŒæ„ã€‚"
        
        elif agent_name == "æš§æ˜§æ°›å›´å¸ˆ":
            if "é’ˆå¯¹" in user_input or "å·¥ä½œ" in user_input:
                return "å·¥ä½œåœºåˆä¹Ÿå¯ä»¥æœ‰æš§æ˜§æ„Ÿï½å¯ä»¥è¿™æ ·å›ï¼š'ä½ è¿™ä¹ˆå…³æ³¨æˆ‘çš„å·¥ä½œï¼Œæ˜¯ä¸æ˜¯å¯¹æˆ‘æœ‰ä»€ä¹ˆç‰¹åˆ«çš„æƒ³æ³•ï¼ŸğŸ˜‰' æˆ–è€… 'ä½ è¿™ä¹ˆäº†è§£æˆ‘ï¼Œæ˜¯ä¸æ˜¯å·å·è§‚å¯Ÿæˆ‘å¾ˆä¹…äº†ï¼Ÿ' ç”¨è½»æ¾çš„è¯­æ°”åŒ–è§£ç´§å¼ ï¼ŒåŒæ—¶æ‹‰è¿‘è·ç¦»ã€‚"
            elif "æš§æ˜§" in user_input or "å–œæ¬¢" in user_input:
                return "ä¿æŒè‹¥å³è‹¥ç¦»çš„æ„Ÿè§‰ï¼š'ä½ çŒœçŒœçœ‹ï½' æˆ–è€… 'ä½ è§‰å¾—å‘¢ï¼Ÿä½ è§‰å¾—æˆ‘å¯¹ä½ æ˜¯ä»€ä¹ˆæ„Ÿè§‰ï¼Ÿ' æŠŠä¸»åŠ¨æƒç»™å¯¹æ–¹ï¼Œè®©ä»–ä¸»åŠ¨ã€‚ä¹Ÿå¯ä»¥å›ï¼š'å’Œä½ èŠå¤©æ€»æ˜¯å¾ˆå¼€å¿ƒï¼Œä½†æˆ‘ä¸æƒ³å¤ªå¿«ä¸‹ç»“è®ºï¼Œè®©æˆ‘ä»¬æ…¢æ…¢äº†è§£å½¼æ­¤ï½' æ—¢ç»™äº†å¸Œæœ›ï¼Œåˆä¿æŒäº†ç¥ç§˜æ„Ÿã€‚"
            else:
                return "è¥é€ æš§æ˜§æ°›å›´çš„å…³é”®æ˜¯ï¼š1. ä¿æŒç¥ç§˜æ„Ÿï¼Œä¸è¦ä¸€æ¬¡æ€§æŠŠè¯è¯´æ»¡ 2. ç”¨åé—®å’Œç–‘é—®è®©å¯¹æ–¹ä¸»åŠ¨ 3. é€‚å½“ç¤ºå¥½ä½†ä¸è¿‡åˆ†ä¸»åŠ¨ 4. ç”¨è¡¨æƒ…å’Œè¯­æ°”è¯å¢åŠ äº²å¯†æ„Ÿ 5. ä¿æŒè‹¥å³è‹¥ç¦»ï¼Œè®©å¯¹æ–¹å¯¹ä½ äº§ç”Ÿå¥½å¥‡ã€‚"
        
        return "æ ¹æ®ä½ çš„æƒ…å†µï¼Œæˆ‘å»ºè®®ä½ ä¿æŒå†·é™ï¼Œç†æ€§åˆ†æï¼Œç„¶ååšå‡ºæœ€é€‚åˆä½ çš„å†³å®šã€‚"

